---
title: "Aprenda R com a Marvel"
author: "Wilson Frantine-Silva"
date: "2024-02-09"
output:
  html_document:
    df_print: "kable"
    css: ../css/markdown.css
    output_dir: ../Ex1.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Quem nunca procrastinou vendo um ou vÃ¡rios filmes do MCU? ğŸ¤·â€â™‚ï¸ A saga desde "Homem de Ferro" (2008) atÃ© "End Game" (2019) foi memorÃ¡vel (os demais, bom...)

O importante Ã© que com os dados das franquias, vocÃª aprenderÃ¡ R de forma intuitiva e colocando a mÃ£o na massa, ou melhor, nos dados. Vamos explorar os dados dos filmes da Marvel entre 2008 atÃ© 2022.

-   ğŸ“ [Definindo um DiretÃ³rio de trabalho](#1)
-   ğŸ› ï¸ [Instalando e carregando pacotes](#2)
-   ğŸ“¤ [Importando dados](#3)
-   ğŸ§¹ [Limpando os dados](#4)
-   ğŸ§ [Analisando os dados](#5)
-   ğŸ—œï¸ [Encanando cÃ³digos](#6)
-   ğŸ¤ [ConclusÃ£o](#7)
-   ğŸ‹ğŸ»â€â™‚ï¸ [Para exercitar](#8)
-   ğŸš€ [OMG, SÃ³ o cÃ³digo! Please.](#9 "Se vocÃª estÃ¡ sem paciencia para enrolaÃ§Ã£o, clique aqui!")

Antes de comeÃ§armos, precisamos preparar alguns passos, ok?

### ğŸ“ Defininindo o diretÃ³rio de trabalho {#1}

Navegue atÃ© o diretÃ³rio da pasta onde estÃ¡ o arquivo [FilmesMarvel.csv](https://raw.githubusercontent.com/wilsonfrantine/R101/gh-page/data/MarvelMovies.csv) e defina-o como **diretÃ³rio de trabalho**. VocÃª sÃ³ precisa digitar `setwd("o caminho para sua pasta")`:

```{r}
setwd('../../R101/Rmd')
```

> Geralmente esse caminho Ã© alguma coisa como: `C:/Users/Wilson/Documentos/`
>
> Que ğŸ‘¿ Ã© um diretÃ³rio de trabalho?[^1]

[^1]: **DiretÃ³rio de trabalho:** Ã‰ a pasta no seu computador que o *R* imagina que estÃ¡ no momento. Geralmente ele abre em seus documentos, que "fisicamente" fica em C:/Users/SeuUsuÃ¡rio/Documentos/ onde "SeuUsuÃ¡rio" Ã© o nome de usuÃ¡rio do seu computar. No meu caso Ã© "Wilso" sim, "Wilso", porque o gÃªnio aqui fez correndo no dia e ficou com preguiÃ§a de arrumar... Geralmente, quando vocÃª configura o seu PC pela primeira vez, ele pede seu nome, e se vocÃª escreve direito (nÃ£o Ã© o meu caso), vocÃª ganha um nome de usuÃ¡rio igual ao seu primeiro nome.

### ğŸ›  Instalando e Carregando pacotes {#2}

A melhor coisa do R Ã© que hÃ¡ um pacote[^2] para tudo. Hoje usaremos o `tidyverse`

[^2]: **Pacote?** Ã‰ um conjunto de funÃ§Ãµes "empacotadas" que algum anjoğŸ‘¼ do Senhor escreveu p facilitar o seu trabalho. Ou seja, ao invÃ©s de reinventar a roda, vocÃª sÃ³ importa a roda da China e coloca na sua bicicleta para rodar. ğŸš´

Para Instalar, use:

```{r, eval=FALSE}
install.packages("tidyverse")
```

Se correu tudo bem, carregue o pacote:

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
```

### ğŸ“¤ Importando os dados {#3}

Carregar o arquivo CSV e atribuir aos dados_filmes:

```{r}
dados_filmes <- read_csv("../data/MarvelMovies.csv")
```

> â— **IMPORTANTE:** Caso seu arquivo tenha outro delimitador que nÃ£o uma vÃ­rgula use a funÃ§Ã£o 'read_delim("MarvelMovies.csv", delim = ";")'.\
> Note que a funÃ§Ã£o `read_delim()` tem o parÃ¢metro `delim` que nos permite dizer que o simbolo "ponto e vÃ­rgula" Ã© quem define os campos da nossa tabela.

Para garantir que estÃ¡ tudo bem. Vamos vizualizar a nossa tabela `dados_filmes`, rapidamente no prompt de saÃ­da do R. Utilize a funÃ§Ã£o `head()` para ver as seis primeiras linhas da tabela

```{r}
head(dados_filmes) 
```

> ğŸ’¡ **DICA**: VocÃª pode utilizar `tail(dados_filmes)` para ver as seis Ãºltimas linhas da tabela, ou View(dados_filmes) para ver esse objeto em uma aba separada do editor do *Rstudio*

Se vocÃª vizualizou a tabela no prompt de saÃ­da com todos os campos, Ã© sinal que estÃ¡ tudo certo!

### ğŸ§¹ Limpando dados {#4}

Frequentemente os dados nÃ£o estÃ£o formatados corretamente para a anÃ¡lise. Os nomes das colunas em nossa tabela original sÃ£o difÃ­ceis de interpretar, entÃ£o vamos alterÃ¡-los para algo mais amigÃ¡vel. **Os nomes atuais das colunas:**

```{r}
#Checar o nome das colunas
colnames(dados_filmes)
```

Como vimos, nomes pÃ©ssimos...

*Vamos dar novos nomes!*

> â— **IMPORTANTE:** Deve haver um nome para para cada coluna

```{r}
#novos nomes
novo_nome_colunas <- c(
  "filme",
  "categoria",
  "receita_mundial_milhoes",
  "percentual_orcamento_recuperado",
  "percentual_criticos",
  "percentual_audiencia",
  "desvio_percentual_audiencia_criticos",
  "orcamento_milhoes",
  "receita_domestica_milhoes",
  "receita_internacional_milhoes",
  "fim_de_semana_abertura_milhoes",
  "segundo_fim_de_semana_milhoes",
  "queda_1o_para_2o_fim_de_semana",
  "percentual_receita_fim_de_semana_abertura",
  "percentual_receita_domestica",
  "percentual_receita_internacional",
  "percentual_orcamento_fim_de_semana_abertura",
  "ano",
  "fonte"
)
```

Agora, basta atribuir os nomes:

```{r}
colnames(dados_filmes) <- novo_nome_colunas
```

Acima a funÃ§Ã£o `colnames()` atribui os nomes do ["*vetor*"](#tooltip "vetor Ã© uma sequencia de elementos, tantos nÃºmeros quanto letras, palavras ou uma mistura dos dois") `novo_nome_colunas`

> ğŸ’¡ **Voce jÃ¡ sabe, mas nÃ£o custa lembrar**: VocÃª pode utilizar `View(dados_filmes)` para visualizar graficamente a tabela no *Rstudio*
>
> Mas vocÃª tambÃ©m pode utilizar a funÃ§Ã£o `head()` para mostrar o cabeÃ§alho da tabela. `head(dados_filmes, n = 3)`

#### Continuando a limpeza:

Repare que nossa tabela tem colunas de percentagem que *nÃ£o sÃ£o nÃºmeros* ğŸ¤¦ğŸ»â€â™‚ï¸. Os campos percentagem tem o sÃ­mbolo "%" inseridos ao lado dos nÃºmeros, o que obriga o R Ã  interpretÃ¡-los como texto.

**Vamos fazer uma mÃ¡gica e corrigir isso:**

```{r}
dados_filmes <- 
  dados_filmes %>%
  mutate_if(
    ~any(str_detect(.,"%")), ~as.numeric(str_remove_all(., "%"))
    )
head(dados_filmes)
```

Mas que ğŸ¤¬ acontenceu ali em cima?

As linhas acima pegam a tabela `dados_filmes` mudando os valores nas colunas **se** ele contiver qualquer simbolo de percentagem "%", utilizando `str_detect(., "%")`, em seguida traforma-o em numÃ©rico com `~as.numeric(str_remove_all(., "%")`.

Note que as funÃ§Ãµes `str_detect` e `str_remove_all`, respectivamente, encontram caracteres (ou `strings` como sÃ£o chamadas no R) e os removem.

Quer mais detalhes? Olhe no rodapÃ© [^3]

[^3]: **O cÃ³digo** `dados_filmes <- dados_filmes %>% mutate_if(~any(str_detect(.,"%")),~as.numeric(str_remove_all(.,"%")))`\
    quer dizer que `dados_filmes` Ã© encanado com `%>%` para dentro da funÃ§Ã£o mutate_if(), que diz: mude "se" as condiÃ§Ãµes forem atendidas. A condiÃ§Ã£o Ã©: tem "%" no valor? Para testar isso escrevemos: `~any(str_detect(.,"%"))` ; Que traduzindo diz: ao longo das colunas (\~) em qualquer uma delas (any), detecte a string `"%"` com `str_detect;` se detectar retorne verdadeiro, senÃ£o falso. ApÃ³s a virgula com: `~as.numeric(str_remove_all(., "%"))` dizemos o seguinte: em funÃ§Ã£o do que vier de lÃ¡ (\~) transforme em numÃ©rico com `as.numeric()` o resultado de str_remove_all(. , "%") que remove de todas as colunas `.` o caracter `"%"`

### ğŸ§ Analisando os dados {#5}

Aleluia...ğŸ™ŒğŸ½\
Eu sei. Parece muito trabalho, mas um dia vocÃª me agradecerÃ¡ (ou nÃ£o ğŸ¤·ğŸ»â€â™€ï¸)

EntÃ£o, partiu!ğŸš€

Uma forma muito rÃ¡pida de olhar um resumo dos dados Ã© com a funÃ§Ã£o `summary()` . Com ela podemos ter um resumo estatÃ­stico de cada variÃ¡vel (ou seja, cada coluna da tabela).

```{r}
summary(dados_filmes) %>% head(1)
```

Meio bagunÃ§ado, certo... Vamos melhorar isso!\

```{r}
dados_resumidos <- 
dados_filmes %>% summary() %>% 
  as.data.frame() %>%
  setNames(c("V1","coluna", "Freq")) %>%
    separate(Freq, into  = c("medida", "valores"), sep = ":") %>%
  select(coluna, medida, valores) %>% drop_na()

head(dados_resumidos, n=12)
```

Agora temos uma tabela com 3 colunas: `coluna`, `medida` e `valores`. Para cada coluna que tinhamos, `summary()` fez o levantamento que poderia: mÃ­nimo, mÃ¡ximo, mÃ©dia, mediana e quartis quando os valores eram nÃºmeros; ou contagens identificaÃ§Ã£o de classe e categoria quando era texto.

> ğŸ’¡ **CÃ³digo explicado:** ğŸ‘‡ğŸ½
>
> 1.  No cÃ³digo acima repetimos o `summary()` nos `dados_filmes`, mas transformamos a saÃ­da em um `data.frame` (quadro de dados ou tabela, como quizer);
>
> 2.  Depois demos nomes Ã s colunas com `setNames("V1", "coluna", "Freq"`);
>
> 3.  Usando `separate()` e "dois pontos" `":"` como separador, quebramos os dados dentro da coluna `Freq` (que estavam como "Mean: 10.1"), em duas novas colunas, as quais chamamos de `"medida"` e `"valores"` ;
>
> 4.  por fim, usamos `select()` para selecionar `filmes`, `medidas` e `valores`e removemos os dados nulos com `drop_na()`

#### ğŸ”½ Filtrando dados:

Podemos aproveitar os `dados_resumidos` e viltrar algumas colunas para ver o padrÃ£o dos dados. Por exemplo, imagine que queira ver todas as medidas sumarizadas da coluna `receita_mundial_milhoes` :

```{r}
dados_resumidos %>% filter( coluna == "receita_mundial_milhoes")
```

Ou ainda se quiser ver o **mÃ¡ximo** de todas as colunas basta:

```{r}
dados_resumidos %>%
  filter(str_detect(medida, "Max"))
```

Agora, imagene que queira trabalhar com a tabela original, `dados_filmes` e filtrar os filmes com receita mundial acima de 1 bilhÃ£o

```{r}
dados_filmes %>% filter(receita_mundial_milhoes > 1000)
```

> Se quiser salvar o resultado em um objeto, basta utilizar:\
> `filmes_acima_de_1_bilhao <- filter(dados_filmes, receita_mundial_milhoes > 1000)`

#### â¬‡ï¸ Ordenar os dados

Para ordenar filmes por percentual de orÃ§amento recuperado em ordem decrescente

```{r}
arrange(dados_filmes, desc(percentual_orcamento_recuperado))
```

a funÃ§Ã£o `arrange()` reordena os `dados_filmes` de com base na classificaÃ§Ã£o feita por `desc` e os dados da coluna `percentual_orcamento_recuperado`

para salvar essa tabela ordenada para calcularmos sobre ela, vamos utilizar:

```{r}
filmes_ordenados <- arrange(dados_filmes, desc(percentual_orcamento_recuperado))
```

#### â• Somar colunas e linhas especificas

Agora utilizamos `filmes_ordandos` para somar os registros do cinco filmes mais rentÃ¡veis da marvel, que agora estÃ£o entre as linhas 1 e 5 da coluna especificada

```{r}
sum(filmes_ordenados[1:5, "receita_mundial_milhoes"])
```

#### ğŸ—œï¸ Encanando cÃ³digos {#6}

Escrevendo em R vocÃª pode se tornar o Super MÃ¡rio ğŸ‘¨ğŸ»â€ğŸ”§(ou quase...). O *R* tem um operador interessante `%>%` ou `|>` ("pipe" ou "cano") que te permite encanar o cÃ³digo Ã  esquerda do operador para dentro do que estÃ¡ Ã  direita do operador.

Veja o cÃ³digo abaixo e note como ele Ã© a mesma coisa do cÃ³digo anterior para soma:

```{r}
filmes_ordenados[1:5, "receita_mundial_milhoes"] %>% sum()
```

Funciona igual para o outro operador `|>`

```{r}
filmes_ordenados[1:5, "receita_mundial_milhoes"] |> sum()
```

A traduÃ§Ã£o para esse cÃ³digo Ã©: pegue a tabela `filmes_ordenados` das linhas 1 Ã  5 na coluna "receita_mundial_milhoes" e some.

A melhor coisa Ã© que, com os canos, vocÃª pode continuar encanando cÃ³digos para dentro de outros quase que para sempre. Por exemplo, digamos que eu queira dividir esse resultado por 2 (`/2`) e depois fazer a raiz quadrada disso (`srqt()`):

```{r}
filmes_ordenados[1:5, "receita_mundial_milhoes"] %>% sum() / 2 %>% sqrt()
```

VocÃª pode ir trabalhando com esses dados atÃ© ter o resultado que quiser.

#### ğŸ¯ Selecionar colunas especÃ­ficas

E se eu quiser uma tabala especÃ­fica sÃ³ com as colunas `'filme'` e `'categoria'` ? Simples, encane `dados_filmes` para dentro de `select` dizendo quais colunas quer:

```{r}
dados_filmes %>% select(filme, categoria)
```

#### â­Criando novas variÃ¡veis

Criar novas variÃ¡veis Ã© Ãºtil quando precisamos calcular coisas novas. Digamos que gostarÃ­amos de calcular a receita total (domÃ©stica + internacional) e adicionar como uma nova coluna.\
\
Para isso temos `mutate`, certamente uma das ferramentas mais importantes do seu arsenal:

Mas, alÃ©m disso, como a tabela ficaria com muitas variÃ¡veis, vamos selecionar apenas o `filme` e a `receita_total`, utilizando `select` e os canos(`%>%`):

```{r}
receita_total <- dados_filmes %>% 
  mutate(receita_total = receita_domestica_milhoes + receita_internacional_milhoes) %>%
  select(filme, receita_total)

receita_total
```

### ğŸ¤ConclusÃ£o {#7}

Ufaa... Chega por hora, certo?

SÃ³ neste exercÃ­cio vocÃª jÃ¡ aprendeu:

-   ğŸ“ [Como definir um DiretÃ³rio de trabalho](#1)
-   ğŸ› ï¸ [Como instalar e carregar pacotes](#2)
-   ğŸ“¤ [Como importar dados](#3)
-   ğŸ§¹ [Como limpar dados de textos indesejados](#4)
-   ğŸ§ [Como interagir com tabelas, como: filtrar, ordenar, somar dados...](#5)
-   ğŸ—œï¸ [Como encadear cÃ³digos com "%\>%"](#6)

*R* parece complexo, e Ã© um pouco, mas Ã© muito poderoso. Te mantÃ©m organizado e consistente. Sem falar que, vocÃª pode ganhar tempo no futuro se atualizar seus dados e precisar refazer as anÃ¡lises.

### ğŸ‹ğŸ»â€â™‚ï¸ Para exercita {#8}

Use o que aprendeu e responda:

1.  Quais os trÃªs filmes do MCU de maior sucesso com a crÃ­tica? (Veja se vocÃª concorda)
2.  E quais os trÃªs filmes de maior sucesso com o pÃºblico? (Seria a voz do povo a voz de Deus?)
3.  Qual foi o mais lucrativo, somando receitas domÃ©sticas (EUA) e internacional?
4.  Qual a mÃ©dia de investimento recuperado?

### ğŸš€ NÃ£o enrola, eu quero o cÃ³digo... {#9}

Sem tempo pra ler? Segue o [cÃ³digo](https://raw.githubusercontent.com/wilsonfrantine/R101/main/ex1/ex1.R "Copie e cole o cÃ³digo no seu Rstudio")ğŸ“œ

#### ReferÃªncias:

1.  Vozes da minha cabeÃ§a (2024)... Brincadeira, tem links uteis abaixo:
2.  [Tidyverse](https://www.tidyverse.org/ "Clique para ir ao site do pacote"). R packages for data science.
3.  [ChatGPT](chat.openai.com "Link para o chatGPT"). Nao Ã© crime se vocÃª souber o que estÃ¡ acontecendo. Do contrÃ¡rio, vocÃª estÃ¡ se sabotando...

The end... [VocÃª pode voltar agora](https://wilsonfrantine.github.io/R101 "Clique no link para voltar Ã  lista de exercÃ­cios"), ou ler:

#### As infinitas notas de rodapÃ©...
